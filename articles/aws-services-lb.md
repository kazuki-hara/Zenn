---
title: "AWSè©¦é¨“å¯¾ç­–: ELB"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

# æ¦‚è¦

- ELBã¯ãƒãƒãƒ¼ã‚¸ãƒ‰ãªãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼

- å¤šãã®AWSã‚µãƒ¼ãƒ“ã‚¹ã¨çµ±åˆå¯èƒ½

## ä¸»ãªè¨­å®šé …ç›®ã‚„ä»•æ§˜

### ELBã®ç¨®é¡

- Application Load Balancer (V2)
  
  - L7ã§å‹•ä½œã™ã‚‹
  
  - åŒã˜EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸Šã§è¤‡æ•°ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«åˆ†æ•£ã§ãã‚‹
  
  - HTTP/2ã¨websocketã«å¯¾å¿œ
  
  - ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«ã‚‚å¯¾å¿œ
  
  - URLã‚„ãƒ›ã‚¹ãƒˆåã€ã‚¯ã‚¨ãƒªã‚„ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ–‡å­—åˆ—ã«åŸºã¥ã„ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ãã‚‹
  
  - ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°æ©Ÿèƒ½ãŒã‚ã‚Šã€EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å‹•çš„ãƒãƒ¼ãƒˆã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¯èƒ½
  
  - Target Groups
    
    - EC2 instances - HTTP
    
    - ECS tasks - HTTP
    
    - Lambda functions
    
    - IP addresses
  
  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒã¯ALBã¨é€šä¿¡ã™ã‚‹ã®ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒã‚ã‹ã‚‰ãªã„ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚µãƒ¼ãƒã«çŸ¥ã‚‰ã›ã‚‹ãŸã‚ã«X-Forwart-Forãƒ˜ãƒƒãƒ€ãƒ¼ã‚’åˆ©ç”¨ã™ã‚‹

- Network Load Balancer (v2)
  
  - L4ã§å‹•ä½œã™ã‚‹
  
  - UDPã¨TCPã«å¯¾å¿œ
  
  - é«˜æ€§èƒ½ãªãŸã‚1ç§’ã«ä½•ç™¾ä¸‡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è£ãã€ALBã¨æ¯”è¼ƒã—ã¦ä½é…å»¶
  
  - NLBã¯AZã”ã¨ã«IPã‚’ã²ã¨ã¤ã‚‚ã¤ã€‚ã¾ãŸElastic IPã«å¯¾å¿œã—ã¦ã„ã‚‹
  
  - Target Groups
    
    - EC2 instances
    
    - IP Addresses - ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹
    
    - ALBã®å‰ã«é…ç½®ã™ã‚‹ã¨æœ‰åŠ¹ã€‚(NLBã§å›ºå®šIPã‚’æ‰‹ã«ã„ã‚Œã€ALBã§HTTPã«å¯¾å¿œã™ã‚‹)
    
    - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¯TCP, HTTP, HTTPSã«å¯¾å¿œã—ã¦ã„ã‚‹

- Gateway Load Balancer (v2)
  
  - FWã‚„IDPã‚’çµŒç”±ã•ã›ãŸã„å ´åˆã¯åˆ©ç”¨ã™ã‚‹
  
  - æœ€æ–°ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼
  
  - VPCã®ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®é€šä¿¡ãŒGLBã‚’çµŒç”±ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚GLBã¯ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä»®æƒ³ã‚¢ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã«ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’è»¢é€ã—ã€ã‚¢ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã‹ã‚‰æˆ»ã£ã¦ããŸãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è»¢é€ã™ã‚‹ã€‚ã‚ˆã£ã¦ã€ã™ã¹ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®å‡ºå…¥ã‚Šå£ã¨ãªã‚‹
  
  - Target Groups
    
    - EC2 instances
    
    - IP addresses - ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIP

### Health Check

- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®ãƒãƒ¼ãƒˆç•ªå·ã‚„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æŒ‡å®šã—ã¦ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã€‚HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ200ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹

### Sticky Sessions

- åŒã˜ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åŒã˜ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å‰²ã‚ŠæŒ¯ã‚‹ã‚ˆã†ã«ã™ã‚‹

- CLB, ALB, NLBã§åˆ©ç”¨å¯èƒ½

- ã‚¯ãƒƒã‚­ãƒ¼ã‚’ä½¿ã£ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹
  
  - Application-based Cookies
    
    - Custom Cookieã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç”Ÿæˆã™ã‚‹ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã«ã‚«ã‚¹ã‚¿ãƒ å±æ€§ã‚’åˆ©ç”¨å¯èƒ½
    
    - Aplication Cookieã¯LBãŒç”Ÿæˆã™ã‚‹ã€‚AWSALBAPPã¨ã„ã†åå‰
  
  - Duration-based Cookies
    
    - AWSALB by ALB, AWSELB by CLB
    
    - LBãŒç”Ÿæˆã™ã‚‹

### Cross-Zone Load Balancing

- è¤‡æ•°ã®LBãŒå­˜åœ¨ã—ã€LBã®å¾Œã‚ã«ã‚ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ã«åã‚ŠãŒã‚ã‚‹ã¨ãã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå„LBã«å¯¾ã—ã¦å‡ç­‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã‚‚ã€LBãŒå„LBã®å¾Œã‚ã«ã‚ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã™ã¹ã¦ã«å¯¾ã—ã¦å‡ç­‰ã«ãªã‚‹ã‚ˆã†ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã™ã‚‹

- ALBã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ã€ç„¡æ–™

- NLBã¨GLBã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç„¡åŠ¹ã€æœ‰åŠ¹ã«ã™ã‚‹ã¨æœ‰æ–™

- CLBã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç„¡åŠ¹ã€æœ‰åŠ¹ã«ã—ã¦ã‚‚ç„¡æ–™

### SSL/TLS

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼é–“ã§é€šä¿¡ã‚’æš—å·åŒ–ã™ã‚‹

- Public SSLè¨¼æ˜æ›¸ã¯CAãŒç™ºè¡Œã™ã‚‹ã€‚SSLè¨¼æ˜æ›¸ã‚’LBã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹

- LBã¯X.509è¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã™ã‚‹ã€‚AWS Certificate Mangeã§ç®¡ç†ã§ãã‚‹

- è‡ªèº«ã®è¨¼æ˜æ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½

- SNI
  
  - ALB, NLB, Cloudfrontã§ä½¿ãˆã‚‹
  
  - ç•°ãªã‚‹SSLè¨¼æ˜æ›¸ã‚’ä½¿ã†è¤‡æ•°ã®Target Groupã«1ã¤ã®LBã«å¯¾å¿œå¯èƒ½ã«ãªã‚‹

### Connection Draining

- Target Groupsã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã«å¼•ã£ã‹ã‹ã£ã¦ã„ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã£ãŸã‚‰ã€ãã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®Œäº†ã™ã‚‹ã¾ã§ã®æ™‚é–“å¾…æ©Ÿã™ã‚‹

- è©²å½“ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã™ã¹ã¦å®Œäº†ã—ãŸã‚‰ã€ãã‚Œä»¥é™ã®é€šä¿¡ã¯ã™ã¹ã¦ä»–ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å‰²ã‚ŠæŒ¯ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹

### Status Code

- 200: Success

- 4XX: Unsuccess at client side
  
  - 400: Bad Request
  
  - 401: Unauthorized
  
  - 403: Forbidden
  
  - 460: Client Closed Connection
  
  - 463: X-Forwarded For header with > 30IP

- 5XX: Unsuccess at server side
  
  - 500: Internal server error â†’ some error on the ELB itself
  
  - 502: Bad gateway
  
  - 503: Service Unavailable
  
  - 504: Gatewayt tiemout

### Monitoring

- CloudWatchã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é€ä¿¡å¯èƒ½
  
  - BackendConnecntionErrors
  
  - Latency
  
  - Healty/Unhealty Host Count
  
  - RequestCount
  
  - RequestCountPerTarget

- ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã¯S3ã«ä¿å­˜å¯èƒ½
  
  - TIme
  
  - Client IP Address
  
  - Latencies
  
  - Request Paths

- Request Tracing
  
  - X--Amzn-Trace-Idã¨ã„ã†HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã§åˆ†æ•£å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ãªã©ã§ã‚‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½è·¡ã§ãã‚‹

### Target Groups Settings

- Slow Start Mode: EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«å¾ã€…ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹æ–¹æ³•ã€‚ã‚¹ãƒ­ãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆç¶™ç¶šæ™‚é–“ã‚’0ã«ã™ã‚‹ã¨ç„¡åŠ¹åŒ–ã§ãã‚‹

- Least Outstanding Requests: ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ãŒæœ€ã‚‚å°‘ãªã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‰²ã‚ŠæŒ¯ã‚‹

- Round Robin: ãƒãƒƒã‚¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«é †ç•ªã«å‰²ã‚ŠæŒ¯ã‚‹

- Flow Hash: IPã‚„Portã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—ã—ã¦å‰²ã‚ŠæŒ¯ã‚‹å…ˆã‚’æ±ºã‚ã‚‹
